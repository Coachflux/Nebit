<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Register — USDT Miner</title>
<style>
  /* Simple attractive crypto style */
  body{margin:0;background:linear-gradient(135deg,#061021,#10203a);font-family:Inter,Arial;color:#e6f7ff;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.06));padding:28px;border-radius:16px;max-width:420px;width:92%;box-shadow:0 20px 50px rgba(0,0,0,0.6)}
  h1{margin:0 0 8px;color:#9ff6ff;text-align:center}
  p.lead{color:#9fbfd4;text-align:center;margin:0 0 18px}
  label{display:block;margin-top:10px;color:#bcdbe6;font-size:13px}
  input{width:100%;padding:11px;border-radius:10px;border:none;margin-top:6px;background:#071827;color:#e6f7ff}
  .btn{margin-top:14px;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,#00d4ff,#7b5cff);color:#021427;font-weight:800;cursor:pointer;width:100%}
  .google{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px;border-radius:10px;background:#fff;color:#000;margin-top:10px;cursor:pointer}
  .note{color:#7fa9bf;font-size:13px;text-align:center;margin-top:12px}
  .small{font-size:12px;color:#9fbfd4;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <h1>USDT Miner</h1>
    <p class="lead">Register to start inviting and earning</p>

    <label>Username (this will be your referral code)</label>
    <input id="username" placeholder="choose-a-username">

    <label>Email</label>
    <input id="email" type="email" placeholder="you@example.com">

    <label>Password</label>
    <input id="password" type="password" placeholder="Create a password">

    <label>Referred by (optional)</label>
    <input id="referredBy" placeholder="friend-username">

    <button id="registerBtn" class="btn">Create account</button>

    <div id="googleBtn" class="google">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google"> Continue with Google
    </div>

    <div class="note">After registration you'll be redirected to login.</div>
    <div style="text-align:center;margin-top:12px"><a href="login.html" style="color:#9ff6ff;text-decoration:none">Already registered? Login</a></div>
    <div class="small">Referral link format: https://usdtmining.github.io/USDT/index.html?ref=username</div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
  // YOUR FIREBASE CONFIG (from you)
  const firebaseConfig = {
    apiKey: "AIzaSyDR_rkTfGLWWX4NRWOVer9wwGlUFiRMRO4",
    authDomain: "usdt-login.firebaseapp.com",
    databaseURL: "https://usdt-login-default-rtdb.firebaseio.com",
    projectId: "usdt-login",
    storageBucket: "usdt-login.firebasestorage.app",
    messagingSenderId: "807602854227",
    appId: "1:807602854227:web:309ae73f572e48dbc7a9a6"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const registerBtn = document.getElementById('registerBtn');
  registerBtn.addEventListener('click', register);

  async function register(){
    const username = (document.getElementById('username').value || '').trim().toLowerCase();
    const email = (document.getElementById('email').value || '').trim();
    const password = document.getElementById('password').value;
    const referredBy = (document.getElementById('referredBy').value || '').trim().toLowerCase() || null;

    if(!username || !email || !password){ alert('Please fill username, email and password.'); return; }

    try{
      // create auth user
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      const uid = cred.user.uid;

      // check uniqueness of username by querying users collection (now allowed because user is authenticated)
      const q = await db.collection('users').where('username','==', username).limit(1).get();
      if(!q.empty){
        // username taken -> delete created user and throw
        await cred.user.delete();
        alert('Username already taken. Choose another and try again.');
        return;
      }

      // write user doc at /users/{uid}
      await db.collection('users').doc(uid).set({
        username,
        email,
        referralCode: username,
        referredBy: referredBy || null,
        referralCount: 0,
        createdAt: new Date().toISOString()
      });

      // If referredBy exists, create a referral event for server-side processing
      if(referredBy){
        await db.collection('referralEvents').add({
          referralCode: referredBy,
          newUid: uid,
          createdAt: new Date().toISOString()
        });
      }

      // sign out (so user can login), redirect to login
      await auth.signOut();
      alert('Registration successful — please login.');
      window.location.href = 'login.html';
    } catch(err){
      alert(err.message || 'Registration failed');
    }
  }

  // Google sign-in: create user doc if missing and then redirect to login (or directly to dashboard)
  document.getElementById('googleBtn').addEventListener('click', async ()=>{
    const provider = new firebase.auth.GoogleAuthProvider();
    try{
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      const uid = user.uid;
      const udoc = await db.collection('users').doc(uid).get();
      if(!udoc.exists){
        // try to reserve a username based on displayName (append random digits if conflict)
        let base = (user.displayName||'user').toLowerCase().replace(/\s+/g,'').replace(/[^\w\-]/g,'') || 'user';
        let candidate = base;
        let taken = true;
        for(let i=0;i<6;i++){
          const q = await db.collection('users').where('username','==', candidate).limit(1).get();
          if(q.empty){ taken=false; break; }
          candidate = base + Math.floor(Math.random()*9000+100);
        }
        await db.collection('users').doc(uid).set({
          username: candidate,
          email: user.email || '',
          referralCode: candidate,
          referredBy: null,
          referralCount: 0,
          createdAt: new Date().toISOString()
        });
      }
      // sign out and redirect to login for consistent UX
      await auth.signOut();
      alert('Google registration complete. Please login (or you will be redirected).');
      window.location.href = 'login.html';
    }catch(err){ alert(err.message || 'Google sign-in failed'); }
  });
</script>
</body>
</html>
